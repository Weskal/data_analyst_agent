# 🤖 SQL Data Analyst Agent

An intelligent SQL data analysis agent that uses AI (OpenAI GPT-4) to generate and execute SQL queries from natural language questions, with a focus on security and automatic result interpretation.

## Table of Contents

- [About](#about)
- [Key Features](#key-features)
- [How It Works](#how-it-works)
- [Architecture](#architecture)

## About

This project implements a data analysis assistant that allows non-technical users to query SQL Server databases using natural language questions. The system leverages LangChain and OpenAI to:

1. **Understand** questions in natural language (English/Portuguese)
2. **Generate** optimized SQL queries based on the database schema
3. **Execute** queries with security validations

### Real-World Example

```
User: "How many employees do we have in total?"

Agent Process:
├─ Generates SQL → SELECT COUNT(*) as Total_Employees FROM Employees
├─ Executes Query → Result: 50 employees
└─ *Coming soon* → AI interprets results from the executed query
```

## Key Features

### 🧠 Intelligent SQL Generation
- Uses GPT-4 with full database schema context
- Automatically optimizes queries for performance
- Handles complex multi-table joins and aggregations

### 🔒 Multi-Layer Security
- **Query Validation**: Blocks dangerous operations (DROP, DELETE, UPDATE, etc.)
- **Read-Only Connection**: Uses `ApplicationIntent=ReadOnly` with limited permissions
- **Automatic Rollback**: Ensures no side effects with `autocommit=False`

### 📊 Multiple Output Formats
Returns data in various formats for flexibility:
- **Pandas DataFrame**: For data manipulation and analysis
- **Markdown Table**: For AI interpretation and documentation
- **JSON**: For API integration
- **Formatted Display**: Pretty tables with tabulate

### Current Visualization 10/11/2025
```
======================================================================
📊 QUERY RESULTS
======================================================================

+-----------------+------------------+
| Department      | Average_Salary   |
+-----------------+------------------+
| IT              | 8500.00          |
| Finance         | 7200.00          |
| HR              | 6800.00          |
+-----------------+------------------+

3 row(s) 
2 column(s)
======================================================================
```

## 🔄 How It Works

### Step-by-Step Process

1. **User Input**: User asks a question in natural language
   ```
   "What is the average salary by department?"
   ```

2. **Schema Context Loading**: System loads the complete database schema
   ```python
   # Tables, columns, relationships, data types
   Tables: Employees, Departments, Salaries
   Relationships: Employees.dept_id → Departments.id
   ```

3. **SQL Generation**: GPT-4 generates optimized SQL query
   ```sql
   SELECT 
       d.name AS Department,
       AVG(s.amount) AS Average_Salary
   FROM Employees e
   JOIN Departments d ON e.dept_id = d.id
   JOIN Salaries s ON e.id = s.employee_id
   GROUP BY d.name
   ORDER BY Average_Salary DESC
   ```

4. **Security Validation**: System validates query safety
   - ✅ Only SELECT statements allowed
   - ✅ No dangerous keywords detected
   - ✅ Read-only user permissions

5. **Query Execution**: Execute against SQL Server
   - Connection via pyodbc with timeout
   - Results limited to prevent overload
   - Automatic rollback after execution

6. **Result Processing**: Convert to multiple formats
   ```python
   {
       "dataframe": <pandas.DataFrame>,
       "markdown": "| Department | Average_Salary |...",
       "json": [{"Department": "IT", "Average_Salary": 8500}, ...],
       "rows": 3,
       "columns": ["Department", "Average_Salary"]
   }
   ```


### Next Implementations:

1. **Custom graphics generation**: Custom graphics and tables generated by the python tool using libs as pyplot/matplotlib/seaborn 
2. **AI Interpretation**: GPT-4 explains results in natural language

## 🏗️ Current Architecture - 10/11/2025

```
┌─────────────────────────────────────────────────────────────┐
│                         User Layer                          │
│                  (Natural Language Question)                │
└────────────────────────────┬────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────┐
│                    LangChain Agent Layer                    │
│  ┌──────────────────────┐  ┌──────────────────────────┐    │
│  │   SQLGenerator Tool  │  │   SQLExecutor Tool       │    │
│  │  - Schema context    │  │  - Security validation   │    │
│  │  - Prompt engineering│  │  - Query execution       │    │
│  └──────────────────────┘  └──────────────────────────┘    │
└────────────┬─────────────────────────────┬──────────────────┘
             │                             │
             ▼                             ▼
┌──────────────────────┐      ┌──────────────────────────┐
│    OpenAI GPT-4      │      │    SQL Server Database   │
│                      │      │                          │
│  - Query generation  │      │  - Read-only connection  │
│  - Error correction  │      │  - Limited permissions   │
│  - Result interpret. │      │  - Timeout protection    │
└──────────────────────┘      └──────────────────────────┘
             │                             │
             └──────────────┬──────────────┘
                            ▼
              ┌───────────────────────────┐
              │    Formatted Results      │
              │  - DataFrame              │
              │  - Markdown               │
              │  - Natural language       │
              └───────────────────────────┘
```

### Component Breakdown

**LangChain Agent**
- Orchestrates the flow between user input and tools
- Manages conversation context
- Handles tool selection and execution order

**SQLGenerator Tool**
- Receives natural language question
- Loads database schema context
- Prompts GPT-4 to generate SQL query
- Validates query format

**SQLExecutor Tool**
- Validates query for dangerous operations
- Establishes read-only database connection
- Executes query with error handling