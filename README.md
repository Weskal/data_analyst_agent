# ğŸ¤– SQL Data Analyst Agent

An intelligent SQL data analysis agent that uses AI (OpenAI GPT-4) to generate and execute SQL queries from natural language questions, with a focus on security and automatic result interpretation.

## Table of Contents

- [About](#about)
- [Key Features](#key-features)
- [How It Works](#how-it-works)
- [Architecture](#architecture)

## About

This project implements a data analysis assistant that allows non-technical users to query SQL Server databases using natural language questions. The system leverages LangChain and OpenAI to:

1. **Understand** questions in natural language (English/Portuguese)
2. **Generate** optimized SQL queries based on the database schema
3. **Execute** queries with security validations

### Real-World Example

```
User: "How many employees do we have in total?"

Agent Process:
â”œâ”€ Generates SQL â†’ SELECT COUNT(*) as Total_Employees FROM Employees
â”œâ”€ Executes Query â†’ Result: 50 employees
â””â”€ *Coming soon* â†’ AI interprets results from the executed query
```

## Key Features

### ğŸ§  Intelligent SQL Generation
- Uses GPT-4 with full database schema context
- Automatically optimizes queries for performance
- Handles complex multi-table joins and aggregations

### ğŸ”’ Multi-Layer Security
- **Query Validation**: Blocks dangerous operations (DROP, DELETE, UPDATE, etc.)
- **Read-Only Connection**: Uses `ApplicationIntent=ReadOnly` with limited permissions
- **Automatic Rollback**: Ensures no side effects with `autocommit=False`

### ğŸ“Š Multiple Output Formats
Returns data in various formats for flexibility:
- **Pandas DataFrame**: For data manipulation and analysis
- **Markdown Table**: For AI interpretation and documentation
- **JSON**: For API integration
- **Formatted Display**: Pretty tables with tabulate

### Current Visualization 10/11/2025
```
======================================================================
ğŸ“Š QUERY RESULTS
======================================================================

+-----------------+------------------+
| Department      | Average_Salary   |
+-----------------+------------------+
| IT              | 8500.00          |
| Finance         | 7200.00          |
| HR              | 6800.00          |
+-----------------+------------------+

3 row(s) 
2 column(s)
======================================================================
```

## ğŸ”„ How It Works

### Step-by-Step Process

1. **User Input**: User asks a question in natural language
   ```
   "What is the average salary by department?"
   ```

2. **Schema Context Loading**: System loads the complete database schema
   ```python
   # Tables, columns, relationships, data types
   Tables: Employees, Departments, Salaries
   Relationships: Employees.dept_id â†’ Departments.id
   ```

3. **SQL Generation**: GPT-4 generates optimized SQL query
   ```sql
   SELECT 
       d.name AS Department,
       AVG(s.amount) AS Average_Salary
   FROM Employees e
   JOIN Departments d ON e.dept_id = d.id
   JOIN Salaries s ON e.id = s.employee_id
   GROUP BY d.name
   ORDER BY Average_Salary DESC
   ```

4. **Security Validation**: System validates query safety
   - âœ… Only SELECT statements allowed
   - âœ… No dangerous keywords detected
   - âœ… Read-only user permissions

5. **Query Execution**: Execute against SQL Server
   - Connection via pyodbc with timeout
   - Results limited to prevent overload
   - Automatic rollback after execution

6. **Result Processing**: Convert to multiple formats
   ```python
   {
       "dataframe": <pandas.DataFrame>,
       "markdown": "| Department | Average_Salary |...",
       "json": [{"Department": "IT", "Average_Salary": 8500}, ...],
       "rows": 3,
       "columns": ["Department", "Average_Salary"]
   }
   ```


### Next Implementations:

1. **Custom graphics generation**: Custom graphics and tables generated by the python tool using libs as pyplot/matplotlib/seaborn 
2. **AI Interpretation**: GPT-4 explains results in natural language

## ğŸ—ï¸ Current Architecture - 10/11/2025

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         User Layer                          â”‚
â”‚                  (Natural Language Question)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    LangChain Agent Layer                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚   SQLGenerator Tool  â”‚  â”‚   SQLExecutor Tool       â”‚    â”‚
â”‚  â”‚  - Schema context    â”‚  â”‚  - Security validation   â”‚    â”‚
â”‚  â”‚  - Prompt engineeringâ”‚  â”‚  - Query execution       â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚                             â”‚
             â–¼                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    OpenAI GPT-4      â”‚      â”‚    SQL Server Database   â”‚
â”‚                      â”‚      â”‚                          â”‚
â”‚  - Query generation  â”‚      â”‚  - Read-only connection  â”‚
â”‚  - Error correction  â”‚      â”‚  - Limited permissions   â”‚
â”‚  - Result interpret. â”‚      â”‚  - Timeout protection    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚                             â”‚
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚    Formatted Results      â”‚
              â”‚  - DataFrame              â”‚
              â”‚  - Markdown               â”‚
              â”‚  - Natural language       â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Component Breakdown

**LangChain Agent**
- Orchestrates the flow between user input and tools
- Manages conversation context
- Handles tool selection and execution order

**SQLGenerator Tool**
- Receives natural language question
- Loads database schema context
- Prompts GPT-4 to generate SQL query
- Validates query format

**SQLExecutor Tool**
- Validates query for dangerous operations
- Establishes read-only database connection
- Executes query with error handling